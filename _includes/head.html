<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
<title>{% if page.title %}{{ page.title }} | {{ site.title }}{% else %}{{ site.title }}{% endif %}</title>
<meta name="description" content="{% if page.description %}{{ page.description }}{% else %}{{ site.description }}{% endif %}">
<!-- Inline Critical CSS -->
<style>
{% include_relative ../css/critical.css %}
</style>

<!-- Load full CSS asynchronously -->
<link rel="preload" href="{{ '/css/styles.min.css?v=8' | relative_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="{{ '/css/styles.min.css?v=8' | relative_url }}"></noscript>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<!-- Critical font-display CSS to prevent FOIT -->
<style>
    @font-face {
        font-family: 'Inter';
        font-style: normal;
        font-weight: 300 700;
        font-display: swap;
        src: local('Inter'), local('Inter-Regular');
    }
    
    /* Fallback font stack while Inter loads */
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
</style>

<!-- Optimized font loading with fallback -->
<script>
    (function() {
        // Web Font Loader approach
        if ('fonts' in document) {
            // Modern browsers - use CSS Font Loading API
            var font = new FontFace('Inter', 'url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7.woff2) format("woff2")', {
                weight: '300 700',
                display: 'swap'
            });
            
            font.load().then(function(loadedFont) {
                document.fonts.add(loadedFont);
                document.documentElement.classList.add('fonts-loaded');
            }).catch(function() {
                // Fallback to link element
                loadFontsViaLink();
            });
        } else {
            // Older browsers - use link element
            loadFontsViaLink();
        }
        
        function loadFontsViaLink() {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap';
            link.media = 'print';
            link.onload = function() { 
                this.media = 'all'; 
                document.documentElement.classList.add('fonts-loaded');
            };
            document.head.appendChild(link);
        }
    })();
</script>
<noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"></noscript>
{% seo %}

<!-- Google Analytics 4 - Optimized Loading -->
<script>
    // Minimal GA initialization
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    
    // Track phone clicks
    function trackPhoneClick() {
        if (typeof gtag !== 'undefined') {
            gtag('event', 'phone_call', {
                'event_category': 'engagement',
                'event_label': 'phone_number_click'
            });
        }
    }
    
    // Track email clicks
    function trackEmailClick() {
        if (typeof gtag !== 'undefined') {
            gtag('event', 'email_click', {
                'event_category': 'engagement',
                'event_label': 'email_address_click'
            });
        }
    }
    
    // Track form submissions
    function trackFormSubmission(formType) {
        if (typeof gtag !== 'undefined') {
            gtag('event', 'form_submission', {
                'event_category': 'conversion',
                'event_label': formType
            });
        }
    }
    
    // Delay GA loading until after page load or user interaction
    let gaLoaded = false;
    function loadGoogleAnalytics() {
        if (!gaLoaded) {
            gaLoaded = true;
            const script = document.createElement('script');
            script.async = true;
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-JNK2QCYSC7';
            script.onload = function() {
                gtag('js', new Date());
                gtag('config', 'G-JNK2QCYSC7', {
                    'custom_map': {'custom_parameter_1': 'consultation_requests'}
                });
            };
            document.head.appendChild(script);
        }
    }
    
    // Load GA on user interaction or after 3 seconds
    if ('requestIdleCallback' in window) {
        requestIdleCallback(loadGoogleAnalytics, { timeout: 3000 });
    } else {
        setTimeout(loadGoogleAnalytics, 3000);
    }
    
    // Also load on first user interaction
    ['click', 'scroll', 'touchstart'].forEach(event => {
        window.addEventListener(event, loadGoogleAnalytics, { once: true, passive: true });
    });
</script>

<!-- Structured Data -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "ProfessionalService",
    "name": "{{ site.title }}",
    "description": "{{ site.description }}",
    "url": "{{ site.url }}",
    "telephone": "{{ site.phone }}",
    "address": {
        "@type": "PostalAddress",
        "streetAddress": "{{ site.address }}",
        "addressLocality": "Smithfield",
        "addressRegion": "RI",
        "addressCountry": "US"
    },
    "areaServed": ["Rhode Island", "Massachusetts", "Connecticut", "New Hampshire", "Vermont", "Maine"],
    "priceRange": "$$$$"
}
</script>

<!-- FAQ Schema - Include if page has FAQs -->
{% include faq-schema.html %}